## camera_utils.py

### Rays

用来描述一个有起点的射线，用于描述某个视图中的“像素空间属性”。

包括两个属性：

o: torch.Tensor, 表示起点（末维度大小为3）

d: torch.Tensor, 表示方向向量（末维度大小为3）

方法：

len（Rays x）,返回数量

x[indices], 返回索引indices对应的o和d组成的Rays

collapse（），返回元组（o，d）

### BoundedRays

类似Rays，只是增加了两个属性near和far，用来表示截取射线的near和far之间的部分，这里的near和far可以认为是o+td中t取值为[near, far]。

#### 其他函数解释

##### apply_rot(pts,rot_mat)

pts: Tensor[3,n], 第i列表示第i个点的xyz坐标

rot_mat: Tensor[3,3], 旋转矩阵

返回：Tensor[3,n], 应用旋转之后的坐标

##### apply_rot_trans(pts, rot_mat, pos)

在上一个方法的基础上加入平移

pos: Tensor[3,] [3,1] 或[3,n]， 表示平移

返回：Tensor[3,n], 旋转后再平移的坐标

##### apply_transform(pts, pose)

以相机外参矩阵pose对pts旋转后再平移

返回: Tensor[3,n]

##### look_at(to_vec, up_vec=None)

以to_vec为前方，up_vec为上方（默认选（0，0，1）），返回相机到世界坐标系的旋转矩阵，即$R_{c2w}$。具体而言：
$$
P_c=R_{w2c}P_w+T\\
P_w=R_{c2w}(P_c-T)
$$
返回：$R_{c2w}$：tensor[3, 3]

##### ang2vec(angles)

angles：tensor[n, 2], 表示n个用经纬度表示的方向向量，angles[i,0]表示经度（以x轴正方向为0，向y轴转动时经度变大），angles[i, 1]表示纬度，在xOy平面上时纬度为0，在y轴正半轴时纬度为$\pi/2$ .

将经纬度转化为方向向量。

返回：tensor[n, 3，1], 表示n个xyz坐标



##### 下面介绍一些出现的坐标表示法：

设图像高h，宽w

**hw坐标**（行列坐标）:用（i，j）表示第i行第j列

**img_coord**（图像坐标）：从0.5/h 到1-0.5/h，包括端点在内均分出h个点，每个值表示对应像素的行坐标，从0.5/w到1-0.5/w， 包括端点在内均分出w个点，每个值表示对应像素的列坐标。简单来讲，就是把行列坐标映射的接近（0，1）的区间里去。

**pano_coord**(全景图坐标）：用经纬度表示图中的像素，左边界为$-\pi$, 有边界为$\pi$, 上边界为$-\pi/2$, 下边界为$\pi/2$。

**direction**（向量坐标）：空间向量（x,y,z)

以下下是对应坐标的转化函数，参数只需保证在最后一维度合法且为tensor即可，返回的tensor形状只会改变最后一维的大小。

img_coord_from_hw（h,w)（这个参数不是tensor，而是两个标量！）

img_to_pano_coord(coords)

pano_to_img_coord(coords)

direction_to_pano_coord(dirs)

pano_coord_to_direction(coords)

direction_to_img_coord(dirs)

img_coord_to_pano_direction(coords)



##### direction_to_pers_img_coord(dirs, to_vec, down_vec, right_vec)

将**向量坐标**dirs转化为指定相机的下的**图像坐标**。

dirs: tensor[..., 3]

返回：

ij: tensor[2,n],

mask tensor[n,]（float） 表示离相机平面不太近、图像坐标又在[0,1]之内的坐标的掩码。即若第i个坐标合适，则mask[i] = 1.0， 否则为0.0



